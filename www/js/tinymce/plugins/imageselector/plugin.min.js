tinymce.PluginManager.add("imageselector", function (editor, f) {

	editor.addButton("imageselector", {
		icon: 'image',
		title: 'Insert image',
		cmd: "imageselector"
	});

	editor.addCommand("imageselector", function () {
		pickingimage = true;
		var w = initialWidth;
		if (initialWidth > initialHeight)
			w = initialHeight;
		if (w > 1080)
			w = 1080;
		w = Math.floor(w * .9);
		window.imagePicker.getPictures(
			function(results) {
				try {
					for (var i=0; i < results.length; i++) {
						dprint('Inserting image: '+results[i], 4);
						convertImgToBase64URL(results[i], function(in_url, imgData) {
							editor.execCommand("mceInsertRawHTML", false, "<img data-mce-src='" + imgData +"' src='" + imgData + "' />");
							if (platform == "android") {
								var url = in_url.substr(7);
								window.requestFileSystem(LocalFileSystem.PERSISTENT, 0, function(fileSystem) {
									fileSystem.root.getFile(url, { create: false }, function(fileEntry) {
										fileEntry.remove(function(file) {
											dprint("Removed file:"+url, 4);
										}, function(error) {
											dprint("Error deleting file: "+error.code+" "+url, 4);
										});
									},
									function(error) {
										dprint("Error: "+error.code+" "+url, 4);
									});
								});
							}
						});
					}
				} catch(e) {
					jsError(e);
				}
			},
			function(error) {
				jsError(error);
			}, {
				maximumImagesCount: 3,
				width: w,
				height: w,
				quality: 80
			});
	});

	editor.addMenuItem("imageselector", {
		cmd: "imageselector",
		context: "insert",
		text: 'Insert image',
		icon: 'image',
	});
});
